# for all ploting code and testing
As mentioned in the data cleaning file, we will be exploring the following prompts and basing the plots off of this.


1. Count the number of offenses per bias to see which group is most frequently targeted


#broad groups
broad_groups <- hateCrime_Final %>%
  mutate(category = case_when(
    Bias %in% c("Anti-Black or African American", "Anti-White", "Anti-Arab",
                "Anti-Asian", "Anti-Hispanic or Latino", "Anti-American Indian or Alaska Native",
                "Anti-Native Hawaiian or Other Pacific Islander",
                "Anti-Multiple Races, Group", "Anti-Other Race/Ethnicity/Ancestry") ~ "Race/Ethnicity",
    
    Bias %in% c("Anti-Jewish", "Anti-Islamic (Muslim)", "Anti-Catholic", "Anti-Buddhist",
                "Anti-Protestant", "Anti-Other Religion", "Anti-Mormon", "Anti-Jehovah's Witness", 
                "Anti-Sikh", "Anti-Atheist/Agnostic") ~ "Religion",
    
    Bias %in% c("Anti-Gay (Male)", "Anti-Lesbian (Female)", "Anti-Heterosexual", 
                "Anti-Transgender", "Anti-Lesbian, Gay, Bisexual, or Transgender (Mixed Group)") ~ "Sexual Orientation",
    
    TRUE ~ "Other"
  ))

# sorting by category

category_summary <- broad_groups %>%
  count(category, name = "total_incidents") %>%
  arrange(desc(total_incidents))

# the plot

ggplot(category_summary, aes(x = reorder(category, -total_incidents), y = total_incidents, fill = category)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  labs(title = "Hate Crimes by Broad Bias Category",
       x = "Bias Category",
       y = "Total Incidents") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 15, hjust = 1))





race_groups <- c("Anti-Black or African American", "Anti-White", "Anti-Arab", "Anti-Asian",
                 "Anti-Hispanic or Latino", "Anti-American Indian or Alaska Native",
                 "Anti-Native Hawaiian or Other Pacific Islander", "Anti-Multiple Races, Group",
                 "Anti-Other Race/Ethnicity/Ancestry")

# filter rows where Bias is in your race_groups
race_data <- hateCrime_Final %>%
  filter(Bias %in% race_groups)

# count how many times each Bias appears
race_summary <- race_data %>%
  count(Bias, name = "total_incidents")

# plot
ggplot(race_summary, aes(x = reorder(Bias, -total_incidents), 
                         y = total_incidents, 
                         fill = Bias)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  labs(title = "Total Number of Hate Crimes by Race",
       x = "Race Targeted",
       y = "Total Number of Reported Incidents") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}

# define sexuality based bias groups
sexuality_groups <- c("Anti-Gay (Male)", 
                      "Anti-Lesbian (Female)", 
                      "Anti-Transgender",
                      "Anti-Heterosexual", 
                      "Anti-Gender Non-Conforming",
                      "Anti-Lesbian, Gay, Bisexual, or Transgender (Mixed Group)")

# filter rows where Bias is in your race_groups
sex_data <- hateCrime_Final %>%
  filter(Bias %in% sexuality_groups)

# count how many times each Bias appears
sex_summary <- sex_data %>%
  count(Bias, name = "total_incidents")

# plot
ggplot(sex_summary, aes(x = reorder(Bias, -total_incidents), 
                         y = total_incidents, 
                         fill = Bias)) +
  geom_bar(stat = "Identity") +
  labs(title = "Total Number of Hate Crimes by Sexuality",
       x = "Sexuality Targeted",
       y = "Total Number of Reported Incidents") 

```

```{r}

# define religious based bias groups
religious_groups <- c("Anti-Jewish", "Anti-Islamic (Muslim)", "Anti-Catholic", "Anti-Buddhist",
                "Anti-Protestant", "Anti-Other Religion", "Anti-Mormon", "Anti-Jehovah's Witness", "Anti-Sikh",
                "Anti-Atheist/Agnostic")

# filter rows where Bias is in your regigious_groups
religion_data <- hateCrime_Final %>%
  filter(Bias %in% religious_groups)

# count how many times each Bias appears
religion_summary <- religion_data %>%
  count(Bias, name = "total_incidents")

# plot
ggplot(religion_summary, aes(x = reorder(Bias, -total_incidents), 
                         y = total_incidents, 
                         fill = Bias)) +
  geom_bar(stat = "Identity") +
  labs(title = "Total Number of Hate Crimes by Religion",
       x = "Religion Targeted",
       y = "Total Number of Reported Incidents") 

```


2. Compare the number of offenses by race to identify which groups are more likely to be the victim to what offenses.

```{r}
#clusters offense type based on everything before ';'
hateCrime_broad1 <- hateCrime_Final %>%
  separate_rows(Offense, sep = ";") %>%
  mutate(
    Offense_Broad = str_trim(Offense)
  )

#clusters bias type based on everything before ';'
hateCrime_broad <- hateCrime_broad1 %>%
  separate_rows(Bias, sep = ";") %>%  # splits at ";"
  mutate(
    Offense_Broad = str_trim(Offense)
  )  %>%
  filter(Bias %in% race_groups) #looks at just race

#table comparing race and offense/ offense frequency
race_based_offenses <- hateCrime_broad %>%
  count(Bias, Offense, name = "total_incidents")

race_based_offenses
```
```{r}
#which 5 offenses per race are most common
largest_per_race <- race_based_offenses %>%
  group_by(Bias) %>%
  slice_max(total_incidents, n = 5)

# top 5 lists across different races organized and tallied
offense_popularity <- largest_per_race %>%
  group_by(Offense) %>%
  summarise(
    races_count = n_distinct(Bias), 
    total_incidents_across_races = sum(total_incidents)
  ) %>%
  arrange(desc(races_count), desc(total_incidents_across_races))


# top 5 offenses that appear in most races and in how many races they appear in
top_common_offenses <- offense_popularity %>%
  slice_max(races_count, n = 5)
top_common_offenses
```
```{r}
# Full table includes only top 5 offenses
top_common_offenses_race <- race_based_offenses %>%
  filter(Offense %in% top_common_offenses$Offense)

# Proportion calculations for scaled bar graph
top_common_offenses_scaled <- top_common_offenses_race %>%
  group_by(Bias) %>%
  mutate(prop = total_incidents / sum(total_incidents)) %>%
  ungroup()

# Plot scaled bar graph
ggplot(top_common_offenses_scaled, aes(x = Bias, y = prop, fill = Offense)) +
  geom_bar(stat = "identity") +
  scale_fill_brewer(palette = "Set2") +  # still works with ggplot2
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(
    title = "Top 5 Race Based Offenses: Scaled",
    x = "Victim Race",
    y = "Incidents Proportion",
    fill = "Offense Type"
  )
```
3. Analyze how the number of offenses has changed over time. 

# Add Year from IncidentDate (safe version)
hateCrime_Final <- hateCrime_Final %>%
  mutate(
    Year_raw = stringr::str_sub(IncidentDate, 1, 4),
    Year = as.numeric(Year_raw),
    Year = ifelse(is.na(Year) | Year < 1900 | Year > 2030, NA, Year)  # filter impossible years
  ) %>%
  filter(!is.na(Year))

# Count incidents per year and broad category
yearly_trend <- hateCrime_Final %>%
  mutate(category = case_when(
    Bias %in% c("Anti-Black or African American", "Anti-White", "Anti-Arab", "Anti-Asian",
                "Anti-Hispanic or Latino", "Anti-American Indian or Alaska Native",
                "Anti-Native Hawaiian or Other Pacific Islander", "Anti-Multiple Races, Group",
                "Anti-Other Race/Ethnicity/Ancestry") ~ "Race/Ethnicity",
    Bias %in% c("Anti-Jewish", "Anti-Islamic (Muslim)", "Anti-Catholic", "Anti-Buddhist",
                "Anti-Protestant", "Anti-Other Religion", "Anti-Mormon", "Anti-Jehovah's Witness",
                "Anti-Sikh", "Anti-Atheist/Agnostic") ~ "Religion",
    Bias %in% c("Anti-Gay (Male)", "Anti-Lesbian (Female)", "Anti-Heterosexual",
                "Anti-Transgender", "Anti-Lesbian, Gay, Bisexual, or Transgender (Mixed Group)") ~ "Sexual Orientation",
    TRUE ~ "Other"
  )) %>%
  count(Year, category, name = "incidents")

# Plot trend over time
ggplot(yearly_trend, aes(x = Year, y = incidents, color = category, group = category)) +
  geom_line(size = 1.2) +
  geom_point(size = 1.5) +
  scale_x_continuous(breaks = seq(min(yearly_trend$Year), max(yearly_trend$Year), by = 1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Hate Crime Incidents Over Time by Bias Category",
       x = "Year", y = "Number of Incidents", color = "Bias Category")

```

4. Examine variation by state of offense types

# Split multiple offenses and clean
state_offense_data <- hateCrime_Final %>%
  tidyr::separate_rows(Offense, sep = ";") %>%
  mutate(Offense = stringr::str_trim(Offense)) %>%
  filter(!is.na(State), State != "")

# Top 3 offenses per state
state_top_offenses <- state_offense_data %>%
  count(State, Offense, name = "incidents") %>%
  group_by(State) %>%
  slice_max(incidents, n = 3) %>%
  ungroup()

# Plot
ggplot(state_top_offenses, aes(x = reorder(State, incidents), y = incidents, fill = Offense)) +
  geom_col(position = "dodge") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 3 Hate Crime Offenses by State",
       x = "State", y = "Number of Incidents", fill = "Offense Type") +
  theme(legend.position = "bottom")

```

5. See how many of each type of offense there is and compare quantities

# Count total occurrences of each offense (split by ';')
offense_totals <- hateCrime_Final %>%
  tidyr::separate_rows(Offense, sep = ";") %>%
  mutate(Offense = stringr::str_trim(Offense)) %>%
  count(Offense, name = "total_incidents") %>%
  filter(!is.na(Offense), Offense != "") %>%
  arrange(desc(total_incidents))

# Plot top 10
ggplot(head(offense_totals, 10), aes(x = reorder(Offense, total_incidents), y = total_incidents)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Top 10 Most Common Hate Crime Offense Types",
       x = "Offense Type", y = "Total Incidents")

```

6. Find correlations between biases and offense (eg. do Asians experience  intimidation based hate crimes or assault based hate crimes)

# Define race biases
race_groups <- c("Anti-Black or African American", "Anti-White", "Anti-Arab", "Anti-Asian",
                 "Anti-Hispanic or Latino", "Anti-American Indian or Alaska Native",
                 "Anti-Native Hawaiian or Other Pacific Islander", "Anti-Multiple Races, Group",
                 "Anti-Other Race/Ethnicity/Ancestry")

# Clean and split Offense and Bias
bias_offense_clean <- hateCrime_Final %>%
  tidyr::separate_rows(Offense, sep = ";") %>%
  tidyr::separate_rows(Bias, sep = ";") %>%
  mutate(Offense = stringr::str_trim(Offense),
         Bias = stringr::str_trim(Bias)) %>%
  filter(Bias %in% race_groups, !is.na(Offense), Offense != "")

# Count and compute % of total offenses *for each bias*
bias_offense_matrix <- bias_offense_clean %>%
  count(Bias, Offense, name = "count") %>%
  group_by(Bias) %>%
  mutate(pct = count / sum(count)) %>%
  ungroup()

# Heatmap: % of incidents per bias that are a given offense
ggplot(bias_offense_matrix, aes(x = Bias, y = Offense, fill = pct)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "lightyellow", high = "darkred", labels = scales::percent) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
  labs(title = "Which Offenses Are Most Common for Each Racial Bias?",
       x = "Targeted Group", y = "Offense Type", fill = "% of Incidents")

```
